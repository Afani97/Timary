{% extends 'timary/base.html' %}
{% block title %} Signup {% endblock %}

{% block content %}
    <div class="max-w-xl mx-auto mt-6">
        <h1 class="text-3xl mb-4 text-center">Signup</h1>

        <div class="flex justify-center">
            <div class="shadow stats flex flex-col w-full md:flex-row mb-10 mx-5">

                <div class="stat flex flex-row md:flex-col justify-between">
                    <div>
                        <div class="stat-title">Starter</div>
                        <div class="stat-value">$5/m</div>
                        <div class="stat-desc">1 invoice</div>
                    </div>
                    <div>
                        <div class="stat-actions">
                            <button class="btn btn-sm btn-accent btn-outline" id="starter">Select</button>
                        </div>
                    </div>
                </div>

                <div class="stat flex flex-row md:flex-col content-center justify-between">
                    <div>
                        <div class="stat-title">Professional</div>
                        <div class="stat-value">$19/m</div>
                        <div class="stat-desc">2 invoices</div>
                    </div>
                    <div>
                        <div class="stat-actions">
                            <button class="btn btn-sm btn-accent plan-chosen" id="professional">Chosen</button>
                        </div>
                    </div>
                </div>

                <div class="stat flex flex-row md:flex-col justify-center content-center justify-between">
                    <div>
                        <div class="stat-title">Business</div>
                        <div class="stat-value">$49/m</div>
                        <div class="stat-desc">unlimited invoices</div>
                    </div>
                    <div>
                        <div class="stat-actions">
                            <button class="btn btn-sm btn-accent btn-outline" id="business">Select</button>
                        </div>
                    </div>
                </div>

            </div>

        </div>

        <div class="card bg-base-200">
            <div class="card-body">
                {% include 'partials/_form.html' with form=form hide_buttons=True %}
                <div class="form-control">
                    <div id="card-element">
                        <!--Stripe.js injects the Payment Element-->
                    </div>
                    <label class="label">
                        <span class="label-text-alt">Stripe requires a debit card to process your invoices into your bank account.</span>
                    </label>
                    <div id="payment-message" class="hidden"></div>
                </div>
                <button class="btn btn-primary mt-2" id="submit-form" type="submit">Continue</button>
                <div class="flex justify-center invisible" id="loader">
                    <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <p class="flex justify-center mt-6">
            <a class="text-sm link link-hover" href="{% url 'timary:login' %}">Login?</a>
        </p>
    </div>

{% endblock %}

{% block js %}
    <script src="https://js.stripe.com/v3/"></script>
    <script nonce="pay-invoice">
        const stripe = Stripe('{{ stripe_public_key }}');

        const starter_plan = document.getElementById("starter");
        const professional_plan = document.getElementById("professional");
        const business_plan = document.getElementById("business");

        starter_plan.addEventListener("click", selectSubscriptionPlan);
        professional_plan.addEventListener("click", selectSubscriptionPlan);
        business_plan.addEventListener("click", selectSubscriptionPlan);

        let elements;
        let cardElement;

        initialize();

        let signupButton = document.querySelector("#submit-form");
        signupButton.addEventListener("click", handleSubmit);

        // Fetches a payment intent and captures the client secret
        function initialize() {
            elements = stripe.elements({ clientSecret: '{{ client_secret }}' });

            cardElement = elements.create("card", {
                style: {
                    base: {
                        iconColor: '#c4f0ff',
                        color: '#fff',
                        fontWeight: '500',
                        fontFamily: 'Roboto, Open Sans, Segoe UI, sans-serif',
                        fontSize: '16px',
                        fontSmoothing: 'antialiased',
                        ':-webkit-autofill': {
                            color: '#fce883',
                        },
                    },
                    invalid: {
                        iconColor: '#ff5724',
                        color: '#ff5724',
                    },
                },
                classes: {
                    base: 'input input-bordered text-lg px-2 py-3'
                }
            });
            cardElement.mount("#card-element");
        }

        function createHiddenInput(el, val) {
            let element = document.createElement("input");
            element.className = el;
            element.name = el;
            element.value = val;
            element.id = `id_${el}`;
            element.hidden = true;
            return element;
        }

        function handleSubmit(e) {
            e.preventDefault();
            document.getElementById("submit-form").classList.add("invisible");
            document.getElementById("loader").classList.remove("invisible");

            stripe.createToken(cardElement, {"currency": "usd"}).then(function(firstToken) {
                let first_token = firstToken.token;
                stripe.createToken(cardElement, {"currency": "usd"}).then(function(secondToken) {
                    let second_token = secondToken.token;

                    if (secondToken.token) {

                        let form = document.querySelector("form");
                        let chosenPlan = document.querySelector(".plan-chosen");
                        form.appendChild(createHiddenInput("membership_tier", chosenPlan.id.toUpperCase()));
                        form.appendChild(createHiddenInput('first_token', first_token.id));
                        form.appendChild(createHiddenInput('second_token', second_token.id));
                        form.submit()

                        // Remove event listener
                        signupButton.removeEventListener("click", handleSubmit);
                    } else {
                        document.getElementById("submit-form").classList.remove("invisible");
                        document.getElementById("loader").classList.add("invisible");
                        if (secondToken.error.type === "card_error" || secondToken.error.type === "validation_error") {
                            showMessage(secondToken.error.message);
                        } else {
                            showMessage("An unexpected error occurred.");
                        }
                    }
                });
            });
        }

        function selectSubscriptionPlan(e) {
            e.preventDefault();
            let old_plan = document.querySelector(".plan-chosen");
            old_plan.classList.remove('plan-chosen');
            old_plan.classList.add('btn-outline');
            old_plan.innerText = "Select";

            let plan = document.getElementById(e.target.id);
            plan.classList.add('plan-chosen');
            plan.classList.remove('btn-outline');
            plan.innerText = "Chosen";
        }

        // ------- UI helpers -------

        function showMessage(messageText) {
            const messageContainer = document.querySelector("#payment-message");

            messageContainer.classList.remove("hidden");
            messageContainer.textContent = messageText;

            setTimeout(function () {
                messageContainer.classList.add("hidden");
                messageText.textContent = "";
            }, 4000);
        }
    </script>
{% endblock %}
