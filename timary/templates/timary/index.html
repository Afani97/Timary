{% extends 'timary/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
    <h1 class="hidden md:block md:text-3xl text-center mt-10 font-bold" id="dashboard-title">Dashboard</h1>
    <div class="flex justify-center my-10 hidden" id="timer_container">
        <div>
            <span class="font-mono text-2xl countdown flex justify-center my-5">
                <span id="timer_hour">00</span>:
                <span id="timer_min">00</span>:
                <span id="timer_sec">00</span>
            </span>
            <div class="btn-group">
                <button id="pause_timer" class="btn btn-active hidden">Pause</button>
                <button id="resume_timer" class="btn btn-active hidden">Resume</button>
                <button id="stop_timer" class="btn hidden">Stop</button>
                <button id="reset_timer" class="btn hidden">Reset</button>
            </div>
        </div>
    </div>
    <div class="grid grid-flow-row md:grid-flow-col md:grid-cols-6 gap-3 mt-10">
        <div class="col-span-3 md:col-span-2">
            <div class="flex flex-col justify-between items-center">
                {# Dashboard stats #}
                <div class="rounded">
                    <h3 class="md:text-lg uppercase text-center mb-2">Current total stats</h3>
                    {% include 'partials/_dashboard_stats.html' %}
                </div>
                {# Dashboard stats #}
            </div>
        </div>

        {# New hours modal #}
        <div id="hours-modal" class="modal items-center">
            <div class="modal-box bg-neutral">
                {{ new_hour_form | safe }}
            </div>
        </div>
        {# New hours modal #}

        {% include "partials/_hours_list.html" %}
    </div>

{% endblock %}


{% block js %}
    <script nonce="manage-hours">
        function clearHoursModal() {
            let errors_list = htmx.find("#new-hours-form .list-none");
            if (errors_list) {
                errors_list.remove();
            }
            htmx.find("#id_hours").value = 1;
            htmx.find("#id_date_tracked").value = new Date().toISOString().split('T')[0];
        }
        htmx.on("clearHoursModal", function(){
            htmx.find("#close-hours-modal").click();
            clearHoursModal();
        })
        {% include "partials/timer_class.html" %}

        var timer_container = document.getElementById("timer_container");
        var start_timer_btn = document.getElementById("start_timer");
        var pause_timer_btn = document.getElementById("pause_timer");
        var resume_timer_btn = document.getElementById("resume_timer");
        var stop_timer_btn = document.getElementById("stop_timer");
        var reset_timer_btn = document.getElementById("reset_timer");
        var timer_hour_span = document.getElementById("timer_hour");
        var timer_min_span = document.getElementById("timer_min");
        var timer_sec_span = document.getElementById("timer_sec");
        var hoursTimer = new timaryTimer();

        start_timer_btn.addEventListener("click", start);
        pause_timer_btn.addEventListener("click", pause);
        stop_timer_btn.addEventListener("click", stop);
        resume_timer_btn.addEventListener("click", resume);
        reset_timer_btn.addEventListener("click", reset);

        function update_timer(hrs, mins, secs) {
            timer_hour_span.style.cssText = `--value: ${hrs}`;
            timer_min_span.style.cssText = `--value: ${mins}`;
            timer_sec_span.style.cssText = `--value: ${secs}`;
        }

        function timer() {
            setInterval(() => {
                const timeInSeconds = Math.round(hoursTimer.getTime() / 1000);
                let hrs = Math.floor(timeInSeconds / 3600);
                let mins = Math.floor((timeInSeconds - (hrs * 3600)) / 60);
                let secs = timeInSeconds % 60;
                update_timer(hrs, mins, secs);
            }, 100)
        }

        function start() {
            hoursTimer.start();
            timer();
            hoursTimer.isPaused = false;
            hoursTimer.isStopped = false;
            timer_container.classList.remove("hidden");
            start_timer_btn.classList.add("hidden");
            pause_timer_btn.classList.remove("hidden");
            stop_timer_btn.classList.remove("hidden");
            reset_timer_btn.classList.remove("hidden");
        }

        function resume() {
            hoursTimer.start();
            timer();
            hoursTimer.isPaused = false;
            hoursTimer.isStopped = false;
            resume_timer_btn.classList.add("hidden");
            pause_timer_btn.classList.remove("hidden");
            stop_timer_btn.classList.remove("hidden");
        }

        function pause() {
            hoursTimer.stop();
            hoursTimer.isPaused = true;
            pause_timer_btn.classList.add("hidden");
            resume_timer_btn.classList.remove("hidden");
            stop_timer_btn.classList.remove("hidden");
        }

        function reset() {
            hoursTimer.stop();
            let reset = confirm("Are you sure you want to reset?");

            if (reset) {
                update_timer(0, 0, 0);
                hoursTimer.reset();
                hoursTimer.isStopped = false;
                hoursTimer.isPaused = false;
            } else {
                if (!hoursTimer.isPaused && !hoursTimer.isStopped) {
                    hoursTimer.start();
                }
            }
        }

        function stop() {
            hoursTimer.stop();
            hoursTimer.isStopped = true;
            let stopped = confirm("Are you sure you want to stop?");

            if (stopped) {

                let log_hours_btn = document.getElementById("log_hours_btn");
                log_hours_btn.click();

                const timeInSeconds = Math.round(hoursTimer.getTime() / 1000);
                let hrs = Math.floor(timeInSeconds / 3600);
                let mins = Math.floor((timeInSeconds - (hrs * 3600)) / 60);

                let hours_input = document.getElementById("id_hours");
                hours_input.value = timeToDecimal(hrs, mins);

                hoursTimer.reset();
                update_timer(0, 0, 0);
                timer_container.classList.add("hidden");
                start_timer_btn.classList.remove("hidden");
                resume_timer_btn.classList.add("hidden");
                pause_timer_btn.classList.add("hidden");
                stop_timer_btn.classList.add("hidden");

            } else {
                if (!hoursTimer.isPaused && hoursTimer.isStopped) {
                    hoursTimer.start();
                }
            }

        }
    </script>
{% endblock  %}
