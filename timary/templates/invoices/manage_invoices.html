{% extends 'timary/base.html' %}

{% block content %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>

    <div class="max-w-5xl mx-auto md:px-5">
        {% if invoices|length != 0 %}
            <div class="flex flex-row justify-between my-8 md:m-8 items-baseline">
                <h1 class="text-3xl text-center font-bold" id="current-invoices">Invoices</h1>
                <div class="flex justify-center">
                    <div class="dropdown dropdown-hover dropdown-bottom dropdown-end">
                        <label tabindex="0" class="btn m-1 btn-primary">New invoice</label>
                        <div tabindex="0" class="dropdown-content">
                            <ul class="menu bg-neutral w-56 rounded-box">
                                <li
                                    hx-get="{% url 'timary:create_invoice' %}?type=1"
                                    hx-target="#new-invoice-inner"
                                    hx-trigger="click"
                                    hx-swap="innerHTML"
                                >
                                    <label class="flex flex-col" for="new-invoice-modal">
                                        <span class="text-xl font-bold text-left">Interval</span>
                                        <span class="text-sm">A recurring invoice sent out on a schedule</span>
                                    </label>
                                </li>
                                <li
                                    hx-get="{% url 'timary:create_invoice' %}?type=2"
                                    hx-target="#new-invoice-inner"
                                    hx-trigger="click"
                                    hx-swap="innerHTML">
                                    <label class="flex flex-col" for="new-invoice-modal">
                                        <span class="text-xl font-bold text-left">Milestone</span>
                                        <span class="text-sm">Break up your invoice into steps</span>
                                    </label>
                                </li>
                                <li
                                    hx-get="{% url 'timary:create_invoice' %}?type=3"
                                    hx-target="#new-invoice-inner"
                                    hx-trigger="click"
                                    hx-swap="innerHTML">
                                    <label class="flex flex-col" for="new-invoice-modal">
                                        <span class="text-xl font-bold text-left">Weekly</span>
                                        <span class="text-sm">Flat rate bill sent out Mondays</span>
                                    </label>
                                </li>
                                <li>
                                    <label>
                                        <a href="{% url 'timary:single_invoice' %}">
                                            <label class="flex flex-col">
                                                <span class="text-xl font-bold text-center mb-2">Single Invoice</span>
                                                <span class="text-sm">Non-recurring one-time invoice</span>
                                            </label>
                                        </a>
                                    </label>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="md:flex justify-center mb-4 hidden">
            <div class="stats shadow">
                <div class="stat place-items-center">
                    <div class="stat-value">${{ sent_invoices_owed|floatformat:-2 }}</div>
                    <div class="stat-desc">owed</div>
                </div>

                <div class="stat place-items-center">
                    <div class="stat-value">${{ sent_invoices_earned|floatformat:-2 }}</div>
                    <div class="stat-desc">total earned</div>
                </div>

            </div>
        </div>

        <ul class="space-y-5" id="invoices-list">
            {% for invoice in invoices %}
                {% include 'partials/_invoice.html' with invoice=invoice %}
            {% empty %}
                <div class="my-10">
                    <div class="flex flex-col justify-center space-y-5">
                        <div class="text-center">
                            <h1 class="mb-5 text-3xl md:text-5xl font-bold" id="intro-text">
                                {% if archived_invoices|length == 0 %}
                                    Hello there
                                {% else %}
                                    New beginning?
                                {% endif %}
                            </h1>
                            <p class="mb-5">
                                {% if archived_invoices|length == 0 %}
                                    We all gotta start somewhere right? Begin your journey by adding your first invoicing details.
                                {% else %}
                                    No rush to starting something new, we'll still be here when you begin again
                                {% endif %}
                            </p>
                        </div>
                        {% include 'invoices/_invoice_selection.html' %}
                    </div>
                </div>
            {% endfor %}
            {% for invoice in single_invoices %}
                <div>{{ invoice.title }}</div>
            {% endfor %}
        </ul>
    </div>

    {% if invoices.count > 0 %}
        <div class="divider"></div>

        <div class="max-w-5xl mx-auto">
            <h3 class="text-xl my-3 font-bold mx-5">Archived invoices</h3>

            {% if archived_invoices.count > 0 %}
                <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    {% for archive_invoice in archived_invoices %}
                        {% include "partials/_archive_invoice.html" with archive_invoice=archive_invoice %}
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

    {% endif %}

    {# New invoice modal #}
    <input type="checkbox" id="new-invoice-modal" class="modal-toggle">
    <div class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-neutral relative sm:w-11/12 max-w-2xl">
            <label _="on click call clearInvoiceModal()"
                for="new-invoice-modal"
                id="close-invoice-modal"
                class="btn btn-sm bg-base-100 btn-circle absolute right-2 top-2">✕</label>
            <div id="new-invoice-inner">
                <div class="flex justify-center">
                    <button class="btn btn-lg loading">loading</button>
                </div>
            </div>

        </div>
    </div>
    {# New invoice modal #}

    {# Edit hours modal #}
    <input type="checkbox" id="edit-hours-modal" class="modal-toggle" />
    <div for="edit-hours-modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box relative bg-neutral">
            <h3 class="font-bold text-lg my-6">Update hours for this invoice period</h3>
            <label
                for="edit-hours-modal"
                class="btn bg-base-100 btn-sm btn-circle absolute right-2 top-2 close-edit-hours-modal"
                _="on click call resetEditHoursView()"
            >
                ✕
            </label>
            <div class="inner-modal" id="edit-hours-inner">
                <div class="flex justify-center">
                    <button class="btn btn-lg loading">loading</button>
                </div>
            </div>
        </div>
    </div>
    {# Edit hours modal #}

    {# Sent invoices modal #}
    <input type="checkbox" id="sent-invoices-modal" class="modal-toggle" />
    <div for="sent-invoices-modal" class="modal modal-bottom md:modal-middle">
        <div class="modal-box relative bg-neutral lg:w-1/2 lg:max-w-5xl">
            <h3 class="font-bold text-lg my-6">View sent invoices</h3>
            <label
                for="sent-invoices-modal"
                class="btn btn-sm bg-base-100 btn-circle absolute right-2 top-2 close-sent-invoices-modal"
                _="on click call resetSentInvoicesView()"
            >✕</label>
            <div class="sent-invoices-inner-modal" id="sent-invoices-inner">
                <div class="flex justify-center">
                    <button class="btn btn-lg loading">loading</button>
                </div>
            </div>
        </div>
    </div>
    {# Sent invoices modal #}

{% endblock %}

{% block js %}
    <script nonce="manage-invoices">
        var LOADER = `
        <div class="flex justify-center">
            <button class="btn btn-lg loading">loading</button>
        </div>
        `;

        function clearInvoiceModal() {
            htmx.find("#new-invoice-inner").innerHTML = LOADER;
            htmx.process(document.body)
        }

        function resetEditHoursView() {
            htmx.find("#edit-hours-inner").innerHTML = LOADER;
        }

        function resetSentInvoicesView() {
            htmx.find("#sent-invoices-inner").innerHTML = LOADER;
        }

        htmx.on("clearInvoiceModal", function(){
            htmx.find("#close-invoice-modal").click();
            htmx.find("#new-invoice-inner").innerHTML = LOADER;
        });
    </script>
{% endblock  %}
