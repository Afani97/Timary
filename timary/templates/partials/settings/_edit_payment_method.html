<form
    action="{% url 'timary:update_payment_method_settings' %}"
    method="post"
    class="col-span-3"
>
    {% csrf_token %}
    <div class="form-control">
        <label class="label"><span class="label-text">Debit card</span> </label>
        <div id="card-element"></div>
        <label class="label">
            <span class="label-text-alt">Stripe requires a debit card to process your invoices into your
                bank account.</span>
        </label>
    </div>

    <div class="flex justify-center space-x-4">
        <a hx-get="{% url 'timary:settings_partial' setting='payment_method' %}"
            hx-target="closest form"
            hx-swap="outerHTML"
            class="btn btn-ghost"
            _="on click add .loading to me">
            Cancel
        </a>
        <button class="btn btn-disabled" id="submit-form" type="submit" _="on click add .loading to me"> Update </button>
    </div>
</form>

<script nonce="update-payment-method" defer>
    var stripe = Stripe('{{ stripe_public_key }}');

    var elements;
    var cardElement;

    initialize();

    // Fetches a payment intent and captures the client secret
    function initialize() {
        elements = stripe.elements({ clientSecret: '{{ client_secret }}' });
        cardElement = elements.create("card", {{ stripe_card_element_ui|safe }});
        cardElement.mount("#card-element");

        cardElement.on('change', function(e) {
            if (e.complete) {
                let submitFormBtn = htmx.find("#submit-form");
                htmx.removeClass(submitFormBtn, "btn-disabled");
                htmx.addClass(submitFormBtn, "btn-primary")
            }
        })
    }

    function createHiddenInput(el, val) {
        let element = document.createElement("input");
        element.className = el;
        element.name = el;
        element.value = val;
        element.id = `id_${el}`;
        element.hidden = true;
        return element;
    }

    function handleSubmit(e) {
        e.preventDefault();

        stripe.createToken(cardElement, {"currency": "usd"}).then(function(firstToken) {
            let first_token = firstToken.token;
            stripe.createToken(cardElement, {"currency": "usd"}).then(function(secondToken) {
                let second_token = secondToken.token;

                if (secondToken.token) {

                    let form = document.querySelector("form");
                    form.appendChild(createHiddenInput('first_token', first_token.id));
                    form.appendChild(createHiddenInput('second_token', second_token.id));
                    form.submit()

                    // Remove event listener
                    signupButton.removeEventListener("click", handleSubmit);
                } else {
                    if (secondToken.error.type === "card_error" || secondToken.error.type === "validation_error") {
                        showMessage(secondToken.error.message);
                    } else {
                        showMessage("An unexpected error occurred.");
                    }
                }
            });
        });
    }
    function showMessage(messageText) {
        const messageContainer = document.querySelector("#payment-message");

        messageContainer.classList.remove("hidden");
        messageContainer.textContent = messageText;

        setTimeout(function () {
            messageContainer.classList.add("hidden");
            messageText.textContent = "";
        }, 4000);
    }
</script>
